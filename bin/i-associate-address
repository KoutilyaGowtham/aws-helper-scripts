#!/bin/bash
# Associate an Elastic IP Address to an instance

source $(dirname $0)/../inc/ec2-include

if [ ! $1 ]; then
  echo "Usage: $(basename $0) IP"
  echo
  echo "           IP - The elastic IP to attach to this instance. "
  echo "                Specifying \"new\" will create a new IP and attach it to this instance. "
  echo
  exit
fi

IP=$1

if [ $IP == "new" ]; then
  echo "Creating IP Address..."
  OUTPUT=$(ec2-allocate-address)
  echo ${OUTPUT[*]}
  echo
  echo "Attaching IP Address..."
  ec2-associate-address -i $INSTANCE_ID ${OUTPUT[1]}
else
  echo "Attaching IP Address..."
  ec2-associate-address -i $INSTANCE_ID $IP
fi

# Make the script wait until the network connection is back up before we continue.
perl -MIO::Socket::INET -e 'until(new IO::Socket::INET("169.254.169.254:80")){print"Waiting for network connection after associating an Elastic IP...\n";sleep 1}'
